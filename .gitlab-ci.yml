image: zephyrprojectrtos/zephyr-build:v0.24.7

variables:
  ZEPHYR_BASE: "/builds/beagleplay/cc1352/zephyr-beagle-cc1352"

build:
  stage: build
  script:
    - rm -rf ../.west
    - west init -l .
    - west update
    - west zephyr-export
    - pip3 install -r scripts/requirements-base.txt
    - pip3 install -r ../bootloader/mcuboot/scripts/requirements.txt
    - west build -d temp/play/blinky -b beagleplay samples/basic/blinky
    - west build -d temp/play/wpanusb -b beagleplay ../modules/wpanusb
    - mkdir -p build/play/blinky/zephyr
    - cp temp/play/zephyr/zephyr.bin build/play/zephyr.bin
    - cp boards/arm/beagle_play_cc1352/cc2538-bsl.py build/play/
    - west build -d temp/freedom/blinky -b beagleconnect_freedom samples/basic/blinky
    - west build -d temp/freedom/sensortest -b beagleconnect_freedom samples/boards/beagleconnect_freedom/sensortest
    - west build -d temp/freedom/mcuboot -b beagleconnect_freedom ../bootloader/mcuboot/boot/zephyr
    - west build -d temp/freedom/mcumgr -b beagleconnect_freedom samples/subsys/mgmt/mcumgr/smp_svr
    - mkdir -p build/freedom/blinky/zephyr
    - cp temp/freedom/blinky/zephyr/zephyr.bin build/freedom/blinky/zephyr/
    - mkdir -p build/freedom/sensortest/zephyr
    - cp temp/freedom/sensortest/zephyr/zephyr.bin build/freedom/sensortest/zephyr/
    - mkdir -p build/freedom/mcuboot/zephyr
    - cp temp/freedom/mcuboot/zephyr/zephyr.bin build/freedom/mcuboot/zephyr/
    - mkdir -p build/freedom/mcumgr/zephyr
    - cp temp/freedom/mcumgr/zephyr/zephyr.bin build/freedom/mcumgr/zephyr/
    - mkdir -p build/freedom/mcumgr-w-boot/zephyr
    - cp temp/freedom/mcuboot/zephyr/zephyr.bin build/freedom/mcumgr-w-boot/zephyr/
    - dd conv=notrunc bs=1 if=temp/freedom/mcumgr/zephyr/zephyr.signed.bin of=build/freedom/mcumgr-w-boot/zephyr/zephyr.bin seek=131072
    - cp boards/arm/beagle_bcf/cc2538-bsl.py build/freedom/
  artifacts:
    paths:
      - build
